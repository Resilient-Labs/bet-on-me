<%- include ('partials/header') -%>

    <head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
            integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
            crossorigin="anonymous" referrerpolicy="no-referrer" />
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/css/userGoal.css">
        <!-- Stripe.js -->
        <script src="https://js.stripe.com/v3/"></script>
    </head>

    <body>
        <main class="user-goal-container py-4">
            <div class="container-fluid px-4">
                <div class="row g-4">
                    <!-- Left Section: Profile -->
                    <div class="col-lg-3 col-md-12">
                        <div class="card shadow-sm border-0 profile-card">
                            <div class="card-body text-center p-4">
                                <a href="/profile" class="d-inline-block mb-3">
                                    <img src="<%= user.profile_image || 'https://via.placeholder.com/120' %>"
                                        alt="Profile Picture" class="profile-pic rounded-circle"
                                        style="width: 120px; height: 120px; object-fit: cover; cursor: pointer; border: 4px solid var(--color-sky-blue);" />
                                </a>
                                <h4 class="fw-bold mb-0">
                                    <%= user.userName %>
                                </h4>
                            </div>
                        </div>
                    </div>

                    <!-- Middle Section: Goal & Wager -->
                    <div class="col-lg-5 col-md-12">
                        <div class="card shadow-sm border-0 goal-card">
                            <div class="card-body p-4">
                                <div class="mb-4">
                                    <h5 class="card-title fw-bold mb-3">
                                        <%= goals?.name ? goals.name : "Big thing I want to accomplish!" %>
                                    </h5>
                                    <% if (goals?.completed===true) { %>
                                        <div class="alert alert-success">
                                             Goal Completed! Get Dat Money!
                                        </div>
                                    <% } else { %>
                                        <div class="alert alert-info">
                                            Start your goal here!
                                        </div>
                                    <% } %>

                                    <% if (goals) { %>
                                        <div class="goal-display mb-4">
                                            <%if(goals?.user==user.id){ %>
                                                <form class="input-area goal-setting" action="/goal/" method="POST">
                                                    <div class="input-group mb-3">
                                                        <input type="text" class="form-control form-control-lg"
                                                            placeholder="Enter Your Goal" id="bigGoal"
                                                            name="name" value="<%= goals?.name %>" />
                                                        <input type="hidden" id="goal-id" value="<%= goals._id %>">
                                                        <!-- Keeping these commented out 
                                                        -->
                                                        <!-- <button class="btn btn-outline-secondary"><i class="fa-solid fa-pen"></i></button> -->
                                                        <!-- <button class="btn btn-primary" id="saveBigThing">
                                                            <i class="fa-solid fa-plus"></i>
                                                        </button> -->
                                                    </div>
                                                </form>
                                            <%}%>
                                        </div>

                                        <div>
                                            <h6 class="fw-bold mb-3">
                                                 Goal Wager
                                            </h6>
                                            <% if (goals?.wagerPaid) { %>
                                                <div class="alert alert-success d-flex align-items-center">
                                                   
                                                    <div>
                                                        <strong>Wager Placed:</strong> $<%= goals?.wagerAmount %>
                                                    </div>
                                                </div>
                                            <% } else { %>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" class="form-control"
                                                        id="wager-amount" name="wagerAmount" placeholder="Enter amount (whole dollars only)" min="1" max="999" step="1" required />
                                                    <button id="place-wager-btn" class="btn btn-success">
                                                        Place Wager
                                                    </button>
                                                </div>
                                            <% } %>
                                        </div>
                                    <% } else { %>
                                        <!-- add form -->
                                        <div class="goal-display mb-4">
                                            <form class="input-area goal-setting" action="/goal/" method="POST">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control form-control-lg"
                                                        placeholder="Enter Your Goal" id="bigGoal"
                                                        name="name" value="<%= goals?.name %>" />
                                                    <button class="btn btn-outline-secondary edit-btn"><i class="fa-solid fa-pen"></i></button>
                                                    <button class="btn btn-primary" id="saveBigThing"><i class="fa-solid fa-plus"></i></button>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="wager-section">
                                            <h6 class="fw-bold mb-3">
                                                <i class="fas fa-dollar-sign me-2"></i> Goal Wager
                                            </h6>
                                            <div class="alert alert-warning">
                                               Create a goal first
                                            </div>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Section: Steps -->
                    <div class="col-lg-4 col-md-12">
                        <div class="card shadow-sm border-0 steps-card">
                            <div class="card-body p-4">
                                <h5 class="card-title fw-bold mb-3">
                                    Action Steps
                                </h5>

                                <form class="input-area mb-3" action="/task/createTask" method="POST">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="task-input" 
                                            placeholder="Enter task" name="title" required />
                                        <input type="text" id="hide-task" placeholder="Name" name="_id" style="display: none;" />
                                        <button type="submit" id="add-task-btn" class="btn btn-primary" 
                                            <%=(goals?.id && goals?.wagerPaid) ? '' : 'disabled' %>
                                            title="<%= (goals?.id && goals?.wagerPaid) ? 'Add task'
                                                : 'Add goal and wager before creating tasks' %>">
                                            <i class="fa-solid fa-plus"></i>
                                        </button>
                                    </div>
                                </form>

                                <% if (typeof messages !== 'undefined' && (messages.error || messages.success)) { %>
                                    <div class="mb-3">
                                        <% if (messages.error) { messages.error.forEach(function(msg){ %>
                                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                                <%= msg %>
                                                <button type="button" class="btn-close" data-bs-dismiss="alert"
                                                    aria-label="Close"></button>
                                            </div>
                                        <% }) } %>
                                        <% if (messages.success) { messages.success.forEach(function(msg){ %>
                                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                                <%= msg.msg %>
                                                <button type="button" class="btn-close" data-bs-dismiss="alert"
                                                    aria-label="Close"></button>
                                            </div>
                                        <% }) } %>
                                    </div>
                                <% } %>
                                
                                <% if (typeof error !== 'undefined') { %>
                                    <div class="alert alert-danger">
                                        <%= error %>
                                    </div>
                                <% } %>

                                <ul class="list-group list-group-flush mb-3" id="task-list">
                                    <% tasks.forEach(task => { %>
                                        <li class="list-group-item task-buttons task-item <%= task.task_is_completed ? 'completed' : '' %> px-0"
                                            data-id="<%= task._id %>">
                                            <div class="d-flex align-items-center">
                                                <input name="checkbox" type="checkbox" 
                                                    class="form-check-input checkbox me-2"
                                                    <%= task.task_is_completed ? 'checked' : '' %>
                                                    data-completed="<%= task.task_is_completed %>" />
                                                    <span name="<%= task._id %>"
                                                        class="task-text flex-grow-1 <%= task.task_is_completed ? 'text-muted' : '' %>">
                                                      <%= task.task_name %>
                                                  </span>

                                                <!-- Default buttons -->
                                                <div class="btn-group btn-group-sm ms-2">
                                                    <button class="btn btn-outline-secondary edit-btn" title="Edit">
                                                        <i class="fa-solid fa-pen"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger delete-btn" title="Delete">
                                                        <i class="fa-solid fa-trash"></i>
                                                    </button>
                                                </div>
                                                <input type="hidden" class="task-id" value="<%= task._id %>">
                                            </div>

                                            <!-- Edit view -->
                                            <form class="edit-task-form d-none mt-2">
                                                <div class="input-group input-group-sm">
                                                    <input name="task-input" class="form-control task-input d-none"
                                                        type="text" value="<%= task.task_name %>" />
                                                    <button class="btn btn-success save-btn d-none" type="button" title="Save">
                                                        <i class="fa-solid fa-check"></i>
                                                    </button>
                                                    <button class="btn btn-secondary cancel-btn d-none" type="button" title="Cancel">
                                                        <i class="fa-solid fa-xmark"></i>
                                                    </button>
                                                </div>
                                            </form>
                                        </li>
                                    <% }) %>
                                </ul>
                                <button class="btn btn-lg btn-success w-100 fw-bold goal-completed"
                                    id="goalCompletedBtn"
                                    <%= tasks.length > 0 && tasks.every(t => t.task_is_completed) ? '' : 'disabled' %>
                                    type="<%= goals === null ? "button" : "submit" %>">
                                    Goal Completed
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Team Preview (Full Width Bottom Section) -->
                    <div class="col-12">
                        <div class="card shadow-sm border-0 team-preview">
                            <div class="card-body p-4">
                                <h5 class="card-title fw-bold mb-4">
                                     Group Progress
                                </h5>
                                <% if (memberProgress && memberProgress.length) { %>
                                    <div class="row g-3">
                                        <% memberProgress.forEach(mp => { %>
                                            <div class="col-lg-3 col-md-6 col-sm-12">
                                                <div class="team-member-card p-3 rounded">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <img src="<%= mp.user.profile_image || 'https://via.placeholder.com/48' %>"
                                                            alt="avatar" class="tp-avatar rounded-circle me-2"
                                                            style="width: 48px; height: 48px; object-fit: cover; border: 2px solid var(--color-foam-green);" />
                                                        <div class="flex-grow-1">
                                                            <div class="fw-bold">
                                                                <%= mp.user.userName %>
                                                            </div>
                                                            <small class="text-muted member-percent" data-user-id="<%= mp.user._id %>">
                                                                <%= mp.percent %>% Complete
                                                            </small>
                                                        </div>
                                                    </div>
                                                    <div class="progress tp-progress" style="height: 8px;">
                                                        <div class="progress-bar tp-progress-bar" role="progressbar"
                                                            data-user-id="<%= mp.user._id %>" 
                                                            data-percent="<%= mp.percent %>"
                                                            style="width: <%= mp.percent %>%;"
                                                            aria-valuenow="<%= mp.percent %>" 
                                                            aria-valuemin="0"
                                                            aria-valuemax="100"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        <% }) %>
                                    </div>
                                <% } else { %>
                                    <div class="text-center py-5 text-muted">
                                       
                                        <p class="mb-0">No team members yet.</p>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete Confirmation Modal -->
            <dialog id="deleteModal" class="login-modal delete-modal" style="background-color: var(--color-foam-green); color:var(--color-black);
            border: 1px solid var(--color-black); border-radius: 6px; padding: 2rem;">
                <div class="modal-content" style="display: flex; justify-content: center; align-items: center; text-align: center;">
                    <h2>Delete Task</h2>
                    <p>Are you sure you want to delete this task?<br>
                        This action cannot be undone.</p>
                    <div class="modal-buttons">
                        <button class="modal-btn cancel-modal-btn" id="cancelDelete"
                        style="margin-top: .5rem; border: 1px solid var(--color-black); background-color: var(--color-black); color: var(--color-white); padding: .5rem 2rem;"
                        >Cancel</button>
                        <button class="modal-btn confirm-modal-btn" id="confirmDelete"
                        style="margin-top: .5rem; border: 1px solid var(--color-black); background-color: var(--color-black); color: var(--color-white); padding: .5rem 2rem;"
                        >Delete</button>
                    </div>
                </div>
            </dialog>

        </main>
        <script async src="https://ga.jspm.io/npm:es-module-shims@1.6.3/dist/es-module-shims.js" crossorigin="anonymous">
        </script>
        <script type="importmap">
            {
                "imports": {
                "three": "https://unpkg.com/three@0.159.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.159.0/examples/jsm/"
                }
            }
        </script>
        <script type="module" src="/js/confetti.js"></script>

        <!-- Bootstrap JS Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/js/goal.js"></script>
        <script src="/js/stripe.js"></script>
    </body>
    <%- include ('partials/footer') -%>
