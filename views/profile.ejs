<%- include('partials/header') -%>



<div class="team-progress-container">
  <div class="container py-5">
    <div class="row g-4">

      <!-- LEFT COLUMN -->
      <div class="col-lg-4">

        <!-- PROFILE CARD -->
        <div class="card shadow-sm text-center mb-4 user-card">
          <div class="card-body">



            <!-- PROFILE IMAGE -->
            <img src="<%= user.profile_image || 'https://via.placeholder.com/150' %>" class="rounded-circle mb-3" style="
                        width: 300px;
                        height: 300px;
                        object-fit: cover;
                        border-radius: 50%;
                        border: 3px solid var(--color-black);
                      ">

            <br>
            <button class="btn w-100 btn-profile">
              <form action="/users/update-picture" method="POST" enctype="multipart/form-data" class="mt-2">
                <input type="file" name="profile_image" id="imageUpload" class="d-none" accept="image/*">

                <label for="imageUpload" class="btn btn-sm w-100">
                  Upload Profile Photo
                </label>
              </form>
            </button>
          </div>
        </div>





        <!-- ACCOUNT INFO -->
        <div class="card shadow-sm user-card">

          <div class="team-card-header account-info">
            <h4 class="mb-0">Account Info</h4>
            <% if(Number.isNaN(parseInt(user.wallet))) { %>
            <div class="wallet">
              <i class="fa-solid fa-wallet"></i> $0
            </div>
            <% }else{ %>
            <div class="wallet">
              <i class="fa-solid fa-wallet"></i> $<%= parseInt(user.wallet) %>
            </div>
            <% } %>
            <div>
              <section>

                <h1>Withdraw Funds</h1>

                <div>
                  <label for="amount">Withdrawal Amount (in USD):</label>
                  <input type="number" id="amount" min="1" placeholder="Enter amount">

                  <button id="withdrawButton">Process Withdrawal</button>
                </div>

                <div id="result" class="result" style="display: none;"></div>

                <script>
                  document.getElementById('withdrawButton').addEventListener('click', async function() {
                    const amount = document.getElementById('amount').value;

                    if (!amount || amount <= 0) {
                      showResult('Please enter a valid amount', 'error');
                      return;
                    }

                    // Show processing
                    showResult('Processing withdrawal...', '');

                    try {
                      const response = await fetch('/stripe/process-payout', {
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                          amount: parseInt(amount)
                        })
                      });

                      const data = await response.json();

                      console.log(data)

                      console.log(document.querySelector('.wallet').childNodes[3])

                      document.querySelector('.wallet').innerHTML = `<svg class="svg-inline--fa fa-wallet" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="wallet" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V192c0-35.3-28.7-64-64-64H80c-8.8 0-16-7.2-16-16s7.2-16 16-16H448c17.7 0 32-14.3 32-32s-14.3-32-32-32H64zM416 272a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"></path></svg> $${data.wallet}</path>
                      `

                      if (data.success) {
                        showResult(`You have withdrawn $${amount}!`);
                      } else {
                        showResult(`Error: ${data.error}`, 'error');
                      }
                    } catch (error) {
                      showResult(`Error: ${error.message}`, 'error');
                    }
                  });

                  function showResult(message, type) {
                    const resultElement = document.getElementById('result');
                    resultElement.textContent = message;
                    resultElement.style.display = 'block';
                    resultElement.className = 'result ' + type;
                  }
                </script>
              </section>
            </div>
          </div>


          <div class="card-body">

            <p><strong style="color: var(--btn-color);">User Name:</strong>
              <%= user.userName %>
            </p>
            <p><strong style="color: var(--btn-color);">Email:</strong>
              <%= user.email %>
            </p>
            <p class="mb-0">
              <strong style="color: var(--btn-color);">Member Since:</strong>
              <%= new Date(user.createdAt).toLocaleDateString("en-US", { year: "numeric" , month: "long" ,
                  day: "numeric" }) %>
            </p>
          </div>
        </div>

        <!-- ACCOUNT ACTIONS -->
        <div class="card shadow-sm user-card">
          <div class="card-body">

            <button class="btn w-100 mb-2 btn-config btn-foam" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
              Change Password
            </button>

            <button class="btn w-100 btn-config" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
              Delete Account
            </button>

          </div>
        </div>

      </div>

      <!-- RIGHT COLUMN -->
      <div class="col-lg-8 code-container">

        <!-- GOAL CLUSTER -->
        <div class="card shadow-sm user-card">
          <% if(clusters.length === 0) { %>
          <div class="team-card-header">
            <h4 class="mb-0">You're not in a group yet!</h4>
          </div>
          <% } else {%>
          <div class="team-card-header">
            <h4 class="mb-0">Your group</h4>
          </div>
          <% } %>
          <% const cluster=clusters[0] %>
          <div class="card-body">

            <!-- CLUSTER NAME -->
            <div class=" d-flex align-items-center mb-4">
              <h5 class="mb-0 me-3">
                <%= cluster?.cluster_name %>

              </h5>
            </div>

            <!-- MEMBERS HEADER -->
            <h6 class="mb-3">Members</h6>

            <!-- MEMBERS LIST -->
            <div class="row g-3">

              <% if (cluster?.cluster_members?.length) { %>
              <% cluster.cluster_members.forEach(member=> { %>

              <div class="col-md-6">
                <div class="d-flex align-items-center p-3 rounded" style="border: 2px solid; background-color: rgb(235, 232, 232);">

                  <!-- Profile Picture -->
                  <img src="<%= member.profile_image || 'https://via.placeholder.com/50' %>" class="rounded-circle me-3" style="
                            width: 50px;
                            height: 50px;
                            object-fit: cover;
                            border: 2px solid;
                          " />

                  <!-- Username -->
                  <h6 class="fw-semibold mb-0">
                    <%= member.userName %>
                    <% if (String(member._id)===String(user._id)) { %>
                    <span class="ms-2 text-muted">(You)</span>
                    <% } %>
                  </h6>

                </div>
              </div>

              <% }) %>
              <% } else { %>
              <p class="text-muted">No members found.</p>
              <% } %>

            </div><br><br>

            <!-- JOIN CODE -->
            <div>
              <p class="small mb-0" style="font-size: 1rem;">
                Join Code
                <strong style="font-size: 1.2rem;">
                  <%= cluster?.cluster_join_id %>

                  <!-- JOIN_CODE -->
                </strong>
              </p>
            </div>


          </div>
        </div>

        <!-- COMPLETED GOALS -->
        <div class="card shadow-sm user-card">
          <div class="team-card-header ">
            <h4 class="mb-0">Completed Goal History</h4>
          </div>
          <div class="card-body">

            <!-- MONTHLY GOALS SECTION (repeat for each month) -->
            <!-- IF NO COMPLETED GOALS -->
            <% if (completedGoals.length==0) { %>
            <div class="text-center ">
              <p class="mb-0">No completed goals yet. Keep working towards your goals!</p>
            </div>
            <% } else { %>

            <!-- Organize monthly goals by months-->
            <% let monthlyGoals={} %>
            <% const monthNames=["January", "February" , "March" , "April" , "May" ,"June","July", "August"
                    , "September" , "October" , "November" ,"December"] %>
            <% completedGoals.forEach(goal=> { %>
            <% let date %>
            <% if (goal.completedAt===null) { %>
            <% date='unknown date' %>
            <% } else { %>
            <% date=`${monthNames[goal.completedAt.getMonth()]}, ${goal.completedAt.getFullYear()}` %>
            <% } %>
            <% if (!monthlyGoals[date]) { %>
            <% monthlyGoals[date]=[[ goal.name, goal.completedAt ]] %>
            <% } else { %>
            <% monthlyGoals[date].push([goal.name,goal.completedAt]) %>
            <% } %>
            <% }) %>
            <div class="mb-4">
              <!-- For each month, make a header and list the goals -->
              <% for (const [month, goalList] of Object.entries(monthlyGoals)) { %>
              <% goalList.sort((a,b)=> b[1] - a[1]) %>

              <!-- MONTH HEADER -->
              <div class="d-flex align-items-center mb-3">
                <h6 class="mb-0 me-3">
                  <!-- e.g., "December 2025" -->
                  <%= month.replace(',', '') %>
                </h6>

              </div>

              <!-- GOALS LIST -->
              <div class="list-group">
                <% goalList.forEach(ele=> { %>
                <!-- GOAL ITEM (repeat for each goal) -->
                <div class="list-group-item d-flex justify-content-between align-items-start" ; style="background-color: rgb(235, 232, 232); border: 1px solid var(--color-black)">
                  <div class="ms-2 me-auto">
                    <div class="fw-bold">
                      <!-- goal.title -->
                      <%= ele[0] %>
                    </div>
                    <small style="color: #000; opacity: 0.8;">
                      Completed on
                      <!-- goal.completedAt formatted date -->
                      <%= ele[1] ? new Date(ele[1]).toLocaleDateString("en-US", { year: "numeric" , month: "long", day: "numeric" }) : 'unknown date' %>
                    </small>
                  </div>
                  <span style="font-size: 1.5rem; position: relative; top:5px">üèÜ</span>
                </div>
                <%})%>
                <!-- END GOAL ITEM -->
              </div>
            </div>
            <% } %>
            <% } %>
            <!-- END MONTHLY SECTION -->
          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="js/clock.js"></script>
</div>

<!-- CHANGE PASSWORD MODAL -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content login-modal">

      <div class="modal-header" style="border-bottom: 2px solid var(--color-golden-brown);">
        <h5 class="modal-title" style="color: var(--color-pale-yellow); font-size: 1.5rem;">Change Password</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form action="/profile/changePassword" method="POST">

          <div class="mb-3">
            <label class="form-label" style="color: var(--color-pale-yellow);">Current Password</label>
            <div class="input-group">
              <input type="password" class="form-control" name="currentPassword" id="profileCurrentPassword" autocomplete="current-password" required>
              <button type="button" class="input-group-text toggle-password" data-target="profileCurrentPassword" style="cursor: pointer; background-color: var(--color-pale-yellow);">
                <i class="fa-solid fa-eye"></i>
              </button>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label" style="color: var(--color-pale-yellow);">New Password</label>
            <div class="input-group">
              <input type="password" class="form-control" name="newPassword" id="profileNewPassword" autocomplete="new-password" required>
              <button type="button" class="input-group-text toggle-password" data-target="profileNewPassword" style="cursor: pointer; background-color: var(--color-pale-yellow);">
                <i class="fa-solid fa-eye"></i>
              </button>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label" style="color: var(--color-pale-yellow);">Re-type Password</label>
            <div class="input-group">
              <input type="password" class="form-control" name="confirmPassword" id="profileConfirmPassword" autocomplete="new-password" required>
              <button type="button" class="input-group-text toggle-password" data-target="profileConfirmPassword" style="cursor: pointer; background-color: var(--color-pale-yellow);">
                <i class="fa-solid fa-eye"></i>
              </button>
            </div>
          </div>

          <small class="form-text">
            Password must be at least 8 characters.
          </small>
          <!-- in-modal message container (shows flash messages after redirect) -->
          <div id="passwordChangeMessage">
            <% if (typeof messages !=='undefined' ) { %>
            <% if (messages.success) { %>
            <% messages.success.forEach(function(s){ %>
            <div class="alert alert-success w-100 mt-2" role="alert">
              <%= (s.msg || s) %>
            </div>
            <% }) %>
            <% } %>
            <% if (messages.errors) { %>
            <% messages.errors.forEach(function(e){ %>
            <div class="alert alert-danger w-100 mt-2" role="alert">
              <%= (e.msg || e) %>
            </div>
            <% }) %>
            <% } %>
            <% } %>
          </div>

          <div class="modal-footer px-0 pb-0" style="border-top: none;">
            <button type="button" class="btn" data-bs-dismiss="modal" style="background-color: var(--color-faded-yellow); color: var(--bg-dark-gray);">Cancel</button>
            <button type="submit" class="btn">Update Password</button>
          </div>

        </form>
      </div>

    </div>
  </div>
</div>

<!-- DELETE ACCOUNT MODAL --Innocent -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content login-modal">

      <div class="modal-header" style="border-bottom: 2px solid #dc3545;">
        <h5 class="modal-title text-danger">Delete Account</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-white">
        <p>
          This action is <strong>permanent</strong> and cannot be undone.
        </p>
        <p>
          Your account, goals, posts, and cluster memberships will be deleted.
        </p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn" data-bs-dismiss="modal" style="background-color: var(--color-yellow);">
          Cancel
        </button>

        <form action="/users/delete-account" method="POST">
          <button type="submit" class="btn btn-danger">
            Yes, Delete My Account
          </button>
        </form>
      </div>

    </div>
  </div>
</div>
<script>
  document.getElementById("imageUpload").addEventListener("change", function() {
    this.form.submit();
  });
</script>


<%- include('partials/footer') -%>