<!-- <%- include('partials/header') -%> -->
<%- include('partials/clockHead') -%>
  <div class="container-fluid team-progress-container">
    <div class="container-fluid px-5">
      <div class="row g-4">

        <!-- LEFT SIDE - Team Progress -->
        <div class="col-lg-8 col-md-7">
          <div class="card shadow-lg border-0 team-card">
            <div class="text-center card-header team-card-header">
              <h2 class="mb-0 text-dark fw-bold">
                <i class="bi me-2"></i>Team Progress
              </h2>
            </div>

            <div class="card-body p-4">

              <!-- Team Name -->
              <div class="group-name-section mb-4">
                <h3 class="fw-bold mb-0 group-name-title">
                  <i class="bi me-2"></i>
                  <%= cluster?.cluster_name || "No Team Yet" %>
                </h3>
              </div>

              <!-- Users and Progress -->
              <% if (members && members.length> 0) { %>
                <% members.forEach((member, index)=> { %>
                  <div class="card user-card mb-3">
                    <div class="card-body p-4">
                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0 fw-bold text-white">
                          <%= member.userName || member.email %>
                        </h5>
                        <span class="badge wager-badge">
                          $<%= member.wagerAmount || 0 %>
                        </span>
                      </div>

                      <!-- Progress Bar -->
                      <div class="progress progress-container">
                        <div class="progress-bar progress-bar-animated progress-bar-gold" role="progressbar"
                          style="width: <%= member.progress || 0 %>%" aria-valuenow="<%= member.progress || 0 %>"
                          aria-valuemin="0" aria-valuemax="100">
                        </div>
                      </div>
                    </div>
                  </div>
                  <% }) %>
                    <% } else { %>
                      <p class="text-muted text-center">No team members yet.</p>
                      <% } %>

                        <h1 style="color: white;">
                          <%= duration.hours%>
                            <%= duration.minutes%>
                              <%= duration.seconds%>
                        </h1>
                        <button id="resetChallenge" /*style="display:none;" * />Reset Challenge (Testing)</button>
            </div>
          </div>
        </div>

        <!-- RIGHT SIDE - Timeline & Cash Jar -->
        <div class="col-lg-4 col-md-5">
          <div class="d-flex flex-column gap-4">

            <!-- Timeline -->
            <div class="card shadow-lg border-0 timeline-card">
              <div class="py-4 team-card-header d-flex align-items-center">
                <h4 class="mb-0 text-dark fw-bold flex-grow-1 text-center">Timeline</h4>

                <% if (user && cluster && String(user._id)===String(cluster.user)) { %>
                  <button id="fetchButton" class="btn btn-outline-dark ms-auto">Start Timer</button>
                  <% } %>

                    <% if (user && cluster && String(user._id)===String(cluster.user)) { %>
                      <button id="leaveButton" class="btn btn-outline-dark ms-auto">Leave Cluster</button>
                      <% } %>
              </div>


              <div class="card-body text-center p-5">
                <div class="display-5 fw-bold mb-2 timeline-time">
                  <i class="bi me-2"></i>
                  <%= cluster?.duration %>
                    <div class="countdown-wrapper" id="wholeClock">
                      <div class="countdown"></div>
                    </div>
                </div>
                <h4 class="mb-0 fw-bold">Challenge Duration</h4>
              </div>
            </div>

            <!-- Cash Jar -->
            <div class="card shadow-lg border-0 cash-jar-card">
              <div class="card-header text-center cash-jar-header">
                <h4 class="mb-0 fw-bold">
                  <i class="bi me-2"></i>Cash Jar
                </h4>
              </div>

              <div class="card-body text-center p-4">
                <div class="cash-card">
                  <img src="https://res.cloudinary.com/dphggnlyy/image/upload/v1765558274/Untitled_design_redefb.gif"
                    class="jar-img" alt="Cash Jar">

                  <div class="hover-jar">
                    <div class="amount-list">
                      <% members.forEach((member, index)=> { %>
                        <div class="user-line" style="--delay:<%= index * 0.2 %>s;">
                          <span class="coin-small">ðŸŸ¡</span>
                          <p>
                            <%= member.userName || member.email %>:
                              $<%= member.wagerAmount || 0 %>
                          </p>
                        </div>
                        <% }) %>
                    </div>
                  </div>
                </div>

                <!-- Total Amount -->
                <div class="mt-4">
                  <h2 class="display-2 fw-bold mb-2 cash-jar-total">
                    $
                    <%= members.reduce((sum, m)=> sum + (m.wagerAmount || 0), 0) %>
                  </h2>
                  <p class="mb-0 mt-3 fs-5 fw-bold cash-jar-label">Total Pot</p>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- GIF Reload Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const jarImg = document.querySelector('.jar-img');

      if (jarImg) {
        jarImg.addEventListener('mouseenter', function () {
          const src = this.src.split('?')[0];
          this.src = src + '?t=' + new Date().getTime();
        });

        jarImg.addEventListener('click', function () {
          const src = this.src.split('?')[0];
          this.src = src + '?t=' + new Date().getTime();
        });
      }
    });
  </script>
  <%- include('partials/clockFoot') -%>
    <!-- <%- include('partials/footer') -%> -->